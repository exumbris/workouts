<?php

$source = debug_backtrace();
if($source[0]['file']!=dirname(dirname(__DIR__)).DIRECTORY_SEPARATOR."dbq.php"){
	exit("Unauthorized");
}

/**
 * Echo anything necessary from execute, but make sure it returns true otherwise it will log an error
*/


class workout_management_table_data extends module_workout_management implements imodquery {
	
	//Query: workout_management_table_data
	
	public function execute () {
		$db = $this->db;
		$tosend = array("raw"=>array(),"hash"=>"");
		$stmt = $db->prepare("SELECT `w`.`id`,`w`.`siid`,`w`.`workout_name`,`w`.`workout_attributes`,`w`.`comments`,MAX(`workout_count`.`date`) as `last_done`,COUNT(`workout_count`.`wid`) as `times_done` FROM `workouts` as `w` LEFT JOIN `workout_count` ON `w`.`siid`=`workout_count`.`wid` WHERE 1 GROUP BY `w`.`siid` ORDER BY `last_done` DESC");
		if(!($stmt->execute())){
			self::log_error(mysqli_stmt_error($stmt));
			return FALSE;
		}
		$stmt->bind_result($id,$siid,$name,$attrs,$comments,$last,$times);
		while($stmt->fetch()){
			$temp = str_split($attrs);
			while(count($temp)<count($tosend['attributes'])){
				$temp[]=0;
			}
			$i=0;
			while($i<count($temp)){
				if($temp[$i]==1){
					$tosend['raw'][$id]["attrs"][$i]="Yes";
				}
				else {
					$tosend['raw'][$id]["attrs"][$i]="No";
				}
				$i++;
			}
		}
		return TRUE;
	}
	
}

?>